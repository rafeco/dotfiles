# Modern Bash configuration
# Compatible with bash 4.0+

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# History settings
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoreboth:erasedups  # Ignore duplicates and lines starting with space
shopt -s histappend               # Append to history file, don't overwrite
shopt -s cmdhist                  # Save multi-line commands as one command

# Update LINES and COLUMNS after each command
shopt -s checkwinsize

# Better glob patterns
shopt -s extglob
shopt -s globstar 2>/dev/null     # Enable ** for recursive globbing (bash 4+)

# Case-insensitive tab completion
bind "set completion-ignore-case on"
bind "set show-all-if-ambiguous on"
bind "set mark-symlinked-directories on"

# Colors
export CLICOLOR=1
export LSCOLORS=ExGxBxDxCxEgEdxbxgxcxd

# Prompt
if [[ "$COLORTERM" == "truecolor" ]] || [[ "$TERM" == *"256color"* ]]; then
  # Colorful prompt with git branch
  parse_git_branch() {
    git branch 2>/dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
  }
  export PS1='\[\033[01;36m\]\u@\h\[\033[00m\]:\[\033[01;35m\]\w\[\033[01;33m\]$(parse_git_branch)\[\033[00m\]\$ '
else
  export PS1='\u@\h:\w\$ '
fi

# Aliases
alias ls='ls --color=auto'
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'

alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

alias h='history'
alias hg='history | grep'
alias c='clear'

# Git aliases (if not using gitconfig aliases)
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gd='git diff'
alias gl='git log --oneline --decorate --graph'
alias gp='git push'
alias gpl='git pull'

# Safety aliases
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Directory navigation
alias cdp='cd -'  # Go to previous directory

# Make directory and cd into it
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Extract various archive formats
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"     ;;
      *.tar.gz)    tar xzf "$1"     ;;
      *.bz2)       bunzip2 "$1"     ;;
      *.rar)       unrar x "$1"     ;;
      *.gz)        gunzip "$1"      ;;
      *.tar)       tar xf "$1"      ;;
      *.tbz2)      tar xjf "$1"     ;;
      *.tgz)       tar xzf "$1"     ;;
      *.zip)       unzip "$1"       ;;
      *.Z)         uncompress "$1"  ;;
      *.7z)        7z x "$1"        ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Find process by name
psgrep() {
  ps aux | grep -v grep | grep -i -e VSZ -e "$@"
}

# Quick search in current directory
search() {
  find . -iname "*$@*" 2>/dev/null
}

# Python virtual environment helper
venv() {
  # If a virtual environment is already active, deactivate it
  if [ -n "$VIRTUAL_ENV" ]; then
    deactivate
    echo "✓ Deactivated virtual environment"
    return 0
  fi

  # Check for existing virtual environments
  if [ -d ".venv" ]; then
    source .venv/bin/activate
    echo "✓ Activated virtual environment (.venv)"
  elif [ -d "venv" ]; then
    source venv/bin/activate
    echo "✓ Activated virtual environment (venv)"
  else
    echo "No virtual environment found in current directory."
    read -p "Create one in .venv? [y/N] " response
    if [[ "$response" =~ ^[Yy]$ ]]; then
      python3 -m venv .venv
      if [ $? -eq 0 ]; then
        source .venv/bin/activate
        echo "✓ Created and activated virtual environment (.venv)"
      else
        echo "✗ Failed to create virtual environment"
        return 1
      fi
    fi
  fi
}

# GitHub account switching
# Configuration stored in ~/.gh-accounts (not tracked in git)

gh-setup() {
  echo "GitHub Account Switcher Setup"
  echo "=============================="
  echo

  # Load existing config if it exists
  if [[ -f ~/.gh-accounts ]]; then
    source ~/.gh-accounts
    echo "Current configuration found. Press Enter to keep current values."
    echo
  fi

  read -e -p "Personal gh username: " -i "$PERSONAL_GH_USER" personal_user
  read -e -p "Personal git email: " -i "$PERSONAL_GIT_EMAIL" personal_email
  read -e -p "Work gh username: " -i "$WORK_GH_USER" work_user
  read -e -p "Work git email: " -i "$WORK_GIT_EMAIL" work_email

  cat > ~/.gh-accounts <<EOF
PERSONAL_GH_USER=$personal_user
PERSONAL_GIT_EMAIL=$personal_email
WORK_GH_USER=$work_user
WORK_GIT_EMAIL=$work_email
EOF

  echo
  echo "✓ Configuration saved to ~/.gh-accounts"
  echo "You can now use gh-personal and gh-work commands"
}

gh-personal() {
  if [[ ! -f ~/.gh-accounts ]]; then
    echo "⚠ Configuration not found. Run 'gh-setup' first."
    return 1
  fi

  source ~/.gh-accounts
  gh auth switch --user "$PERSONAL_GH_USER"
  git config --global user.email "$PERSONAL_GIT_EMAIL"
  echo "✓ Switched to personal account ($PERSONAL_GH_USER / $PERSONAL_GIT_EMAIL)"
}

gh-work() {
  if [[ ! -f ~/.gh-accounts ]]; then
    echo "⚠ Configuration not found. Run 'gh-setup' first."
    return 1
  fi

  source ~/.gh-accounts
  gh auth switch --user "$WORK_GH_USER"
  git config --global user.email "$WORK_GIT_EMAIL"
  echo "✓ Switched to work account ($WORK_GH_USER / $WORK_GIT_EMAIL)"
}

gh-whoami() {
  echo "gh account: $(gh api user --jq .login 2>/dev/null || echo 'not authenticated')"
  echo "git user: $(git config --global user.name) <$(git config --global user.email)>"
}

# Better df output
alias df='df -h'
alias du='du -h'

# Date shortcuts
alias now='date +"%Y-%m-%d %H:%M:%S"'
alias today='date +"%Y-%m-%d"'

# Network
alias ports='netstat -tulanp 2>/dev/null || netstat -an'
alias myip='curl -s ifconfig.me'

# macOS specific
if [[ "$OSTYPE" == "darwin"* ]]; then
  # Use GNU coreutils instead of BSD versions for cross-platform consistency
  if type brew &>/dev/null && [ -d "$(brew --prefix)/opt/coreutils/libexec/gnubin" ]; then
    export PATH="$(brew --prefix)/opt/coreutils/libexec/gnubin:$PATH"
  fi

  # Finder
  alias showfiles='defaults write com.apple.finder AppleShowAllFiles YES; killall Finder'
  alias hidefiles='defaults write com.apple.finder AppleShowAllFiles NO; killall Finder'

  # Lock screen
  alias afk='/System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -suspend'

  # Update Homebrew
  alias brewup='brew update && brew upgrade && brew cleanup'
fi

# Linux specific
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  if command -v sudo &>/dev/null; then
    alias update='sudo apt-get update && sudo apt-get upgrade'
    alias install='sudo apt-get install'
  else
    alias update='apt-get update && apt-get upgrade'
    alias install='apt-get install'
  fi
fi

# Codespaces specific
if [ -n "$CODESPACES" ]; then
  alias browse='gh browse'
  export EDITOR='code --wait'
fi

# Claude Code - add to PATH if installed
if [ -d "$HOME/.claude/bin" ]; then
  export PATH="$HOME/.claude/bin:$PATH"
fi
if [ -d "$HOME/.local/bin" ] && [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$HOME/.local/bin:$PATH"
fi

# Anthropic API key (set in .bashrc.local or environment)
# export ANTHROPIC_API_KEY="your-key-here"

# Better less
export LESS='-R -F -X'
export LESSOPEN='|/usr/bin/lesspipe %s 2>&-'

# Load local bashrc if it exists
if [ -f "$HOME/.bashrc.local" ]; then
  source "$HOME/.bashrc.local"
fi

# Enable programmable completion features
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi

# Homebrew completion (macOS)
if type brew &>/dev/null && [ -f "$(brew --prefix)/etc/bash_completion" ]; then
  . "$(brew --prefix)/etc/bash_completion"
fi
