# Shared shell functions for bash and zsh
# Sourced by both ~/.bashrc and ~/.zshrc

# Make directory and cd into it
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Extract various archive formats
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"     ;;
      *.tar.gz)    tar xzf "$1"     ;;
      *.bz2)       bunzip2 "$1"     ;;
      *.rar)       unrar x "$1"     ;;
      *.gz)        gunzip "$1"      ;;
      *.tar)       tar xf "$1"      ;;
      *.tbz2)      tar xjf "$1"     ;;
      *.tgz)       tar xzf "$1"     ;;
      *.zip)       unzip "$1"       ;;
      *.Z)         uncompress "$1"  ;;
      *.7z)        7z x "$1"        ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Find process by name
psgrep() {
  ps aux | grep -v grep | grep -i -e VSZ -e "$@"
}

# Quick search in current directory
search() {
  find . -iname "*$@*" 2>/dev/null
}

# Python virtual environment helper
venv() {
  # If a virtual environment is already active, deactivate it
  if [ -n "$VIRTUAL_ENV" ]; then
    # Remove the venv bin directory from PATH
    if [ -n "$_VENV_ORIGINAL_PATH" ]; then
      export PATH="$_VENV_ORIGINAL_PATH"
      unset _VENV_ORIGINAL_PATH
    fi
    # Call standard deactivate if available
    if type deactivate &>/dev/null; then
      deactivate
    fi
    unset VIRTUAL_ENV
    echo "✓ Deactivated virtual environment"
    return 0
  fi

  # Check for existing virtual environments
  local venv_path=""
  if [ -d ".venv" ]; then
    venv_path=".venv"
  elif [ -d "venv" ]; then
    venv_path="venv"
  else
    echo "No virtual environment found in current directory."
    echo -n "Create one in .venv? [y/N] "
    read response
    if [[ "$response" =~ ^[Yy]$ ]]; then
      python3 -m venv .venv
      if [ $? -eq 0 ]; then
        venv_path=".venv"
      else
        echo "✗ Failed to create virtual environment"
        return 1
      fi
    else
      return 0
    fi
  fi

  # Activate the virtual environment
  if [ -n "$venv_path" ]; then
    # Store original PATH for restoration on deactivation
    export _VENV_ORIGINAL_PATH="$PATH"

    # Add venv bin directory to PATH
    export PATH="$(pwd)/$venv_path/bin:$PATH"
    export VIRTUAL_ENV="$(pwd)/$venv_path"

    # Also source the activate script for other environment setup
    source "$venv_path/bin/activate"

    echo "✓ Activated virtual environment ($venv_path)"
    echo "  Scripts from installed packages are now on your PATH"
  fi
}

# GitHub account switching helpers
gh-personal() {
  if [[ ! -f ~/.gh-accounts ]]; then
    echo "⚠ Configuration not found. Run 'gh-setup' first."
    return 1
  fi

  source ~/.gh-accounts
  gh auth switch --user "$PERSONAL_GH_USER"
  git config --global user.email "$PERSONAL_GIT_EMAIL"
  echo "✓ Switched to personal account ($PERSONAL_GH_USER / $PERSONAL_GIT_EMAIL)"
}

gh-work() {
  if [[ ! -f ~/.gh-accounts ]]; then
    echo "⚠ Configuration not found. Run 'gh-setup' first."
    return 1
  fi

  source ~/.gh-accounts
  gh auth switch --user "$WORK_GH_USER"
  git config --global user.email "$WORK_GIT_EMAIL"
  echo "✓ Switched to work account ($WORK_GH_USER / $WORK_GIT_EMAIL)"
}

gh-whoami() {
  echo "gh account: $(gh api user --jq .login 2>/dev/null || echo 'not authenticated')"
  echo "git user: $(git config --global user.name) <$(git config --global user.email)>"
}
